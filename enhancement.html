<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>아이템 강화 시뮬레이터</title>
  <style>
    /* ...기존 스타일 유지... */
  </style>
</head>
<body>
  <!-- ...기존 HTML 구조 유지... -->

  <script>
    // 1) entries 선언 및 슬롯 초기화
    const entries = [];
    const entryGrid = document.getElementById('entry-grid');
    for (let i = 0; i < 20; i++) {
      const slot = document.createElement('div');
      slot.className = 'slot';
      entryGrid.appendChild(slot);
    }

    // 2) 상단 강화바 생성 & 클릭 핸들러
    let selectedTarget = 0;
    function setTargetLevel(n) {
      selectedTarget = n;
      updateStepBar();
    }
    function updateStepBar() {
      const safeLevel = entries[0]?.safeLevel || 0;
      document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('selected', i < selectedTarget);
        el.classList.toggle('safe',     i < safeLevel);
      });
    }
    document.getElementById("enhance-bar").innerHTML =
      Array.from({ length: 12 }, (_, i) =>
        `<div class="step" onclick="setTargetLevel(${i+1})">+${i+1}</div>`
      ).join('');
    updateStepBar();

    // 3) 아이템 등록/렌더/리셋
    function registerItem(type, safeLevel) {
      if (entries.length && entries[0].type !== type) {
        alert('동일한 유형만 등록 가능합니다.');
        return;
      }
      if (entries.length >= 20) return;
      entries.push({
        id: Date.now() + Math.random(),
        type,
        level: 0,
        safeLevel,
        destroyed: false
      });
      renderEntries();
      updateStepBar();
    }
    function renderEntries() {
      entryGrid.querySelectorAll('.slot').forEach((slot,i) => {
        slot.innerHTML = '';
        const item = entries[i];
        if (item && !item.destroyed) {
          const card = document.createElement('div');
          card.className = 'card';
          card.textContent = `${item.type[0]}+${item.level}`;
          card.dataset.id = item.id;
          slot.appendChild(card);
        }
      });
    }
    function resetAll() {
      entries.length = 0;
      renderEntries();
      selectedTarget = 0;
      updateStepBar();
    }

    // 4) 확률표 완전 통합 (문법 오류 수정 완료)
    const enhanceRates = {
      "무기_6": {
        "0": { "base":1,    "bless":[0.34,0.33,0.33], "break":false },
        "1": { "base":1,    "bless":[0.34,0.33,0.33], "break":false },
        "2": { "base":1,    "bless":[0.34,0.33,0.33], "break":false },
        "3": { "base":1,    "bless":[0.50,0.50],      "break":false },
        "4": { "base":1,    "bless":[0.50,0.50],      "break":false },
        "5": { "base":1,    "bless":[0.50,0.50],      "break":false },
        "6": { "base":0.51, "bless":[0.51],           "break":true  },
        "7": { "base":0.33, "bless":[0.33],           "break":true  },
        "8": { "base":0.33, "bless":[0.33],           "break":true  },
        "9": { "base":0.10, "bless":[0.10],           "break":true  },
        "10":{ "base":0.04, "bless":[0.04],           "break":true  },
        "11":{ "base":0.01, "bless":[0.01],           "break":true  }
      },
      "방어구_1": {
        "0": { "base":1,      "bless":[0.3334,0.3333,0.3333], "break":false },
        "1": { "base":0.7501,  "bless":[0.2501,0.25,0.25],     "break":true  },
        "2": { "base":0.49,    "bless":[0.1634,0.1633,0.1633], "break":true  },
        "3": { "base":0.33,    "bless":[0.165,0.165],          "break":true  },
        "4": { "base":0.25,    "bless":[0.125,0.125],          "break":true  },
        "5": { "base":0.20,    "bless":[0.10,0.10],            "break":true  },
        "6": { "base":0.20,    "bless":[0.20],                 "break":true  },
        "7": { "base":0.15,    "bless":[0.15],                 "break":true  },
        "8": { "base":0.15,    "bless":[0.15],                 "break":true  },
        "9": { "base":0.10,    "bless":[0.10],                 "break":true  },
        "10":{ "base":0.10,    "bless":[0.10],                 "break":true  },
        "11":{ "base":0.05,    "bless":[0.05],                 "break":true  }
      }
      // ... 나머지 유형도 동일한 방식으로 작성 ...
    };

    function getEnhanceResult(item, bless) {
      const rates = enhanceRates[`${item.type}_${item.safeLevel}`]?.[String(item.level)];
      if (!rates) return { success:false, destroyed:false, increment:0 };
      let success = false, increment = 1;
      if (bless && rates.bless.length > 1) {
        const rnd = Math.random(), arr = rates.bless;
        let acc = 0;
        for (let i = 0; i < arr.length; i++) {
          acc += arr[i];
          if (rnd < acc) { success = true; increment = i+1; break; }
        }
      } else {
        success = Math.random() < rates.base;
      }
      return success
        ? { success:true, destroyed:false, increment }
        : { success:false, destroyed:rates.break, increment:0 };
    }

    function waitForAnim(card, cls) {
      return new Promise(res => {
        card.classList.add(cls);
        card.addEventListener('animationend', () => {
          card.classList.remove(cls);
          res();
        }, { once:true });
      });
    }

    async function enhanceAllSteps() {
      const bless = document.getElementById('blessScroll').checked;

      // 즉시 안전강화
      entries.forEach(it => {
        if (it.level < it.safeLevel && selectedTarget >= it.safeLevel) {
          it.level = it.safeLevel;
        }
      });
      renderEntries();

      // 본격 강화 루프
      while (entries.some(it => !it.destroyed && it.level < selectedTarget)) {
        const promises = entries.map(item => {
          if (item.destroyed || item.level >= selectedTarget) return Promise.resolve();
          if (item.level < item.safeLevel && selectedTarget >= item.safeLevel) {
            return Promise.resolve();
          }

          const result = getEnhanceResult(item, bless);
          item.destroyed = result.destroyed;
          const card = document.querySelector(`.card[data-id="${item.id}"]`);
          if (result.success) {
            item.level += result.increment;
            return waitForAnim(card, 'success');
          } else if (result.destroyed) {
            return waitForAnim(card, 'fail');
          }
          return Promise.resolve();
        });

        await Promise.all(promises);

        // 일괄 제거 및 재렌더
        for (let i = entries.length - 1; i >= 0; i--) {
          if (entries[i].destroyed) entries.splice(i, 1);
        }
        renderEntries();
        updateStepBar();
        await new Promise(r => requestAnimationFrame(r));
      }
    }
  </script>
</body>
</html>
